{"version":3,"file":"next-compute-js-server.js","sourceRoot":"","sources":["../../../src/server/next-compute-js-server.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n *\n * Portions of this file Copyright Vercel, Inc., licensed under the MIT license. See LICENSE file for details.\n */\n\nimport { Buffer } from 'buffer';\nimport { join, relative, resolve } from 'path';\nimport type { ParsedUrlQuery } from 'querystring';\nimport { UrlWithParsedQuery, format as formatUrl } from 'url';\n\nimport {\n  APP_PATHS_MANIFEST,\n  BUILD_ID_FILE,\n  CLIENT_PUBLIC_FILES_PATH,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME,\n  PAGES_MANIFEST,\n  PRERENDER_MANIFEST,\n  ROUTES_MANIFEST,\n  SERVER_DIRECTORY,\n  SERVERLESS_DIRECTORY,\n} from 'next/constants';\nimport { PrerenderManifest } from 'next/dist/build';\nimport { PagesManifest } from 'next/dist/build/webpack/plugins/pages-manifest-plugin';\nimport isError from 'next/dist/lib/is-error';\nimport { CustomRoutes, Rewrite } from 'next/dist/lib/load-custom-routes';\nimport { apiResolver, parseBody } from 'next/dist/server/api-utils/node';\nimport { BaseNextRequest, BaseNextResponse } from 'next/dist/server/base-http';\nimport BaseServer, {\n  FindComponentsResult,\n  NoFallbackError,\n  RequestContext,\n} from 'next/dist/server/base-server';\nimport { FontManifest } from 'next/dist/server/font-utils';\nimport { addRequestMeta, NextParsedUrlQuery, NextUrlWithParsedQuery } from 'next/dist/server/request-meta';\nimport { RenderOpts, renderToHTML } from 'next/dist/server/render';\nimport RenderResult from 'next/dist/server/render-result';\nimport { DynamicRoutes, PageChecker, Route } from 'next/dist/server/router';\nimport { PayloadOptions, sendRenderResult } from 'next/dist/server/send-payload';\nimport {\n  createHeaderRoute,\n  createRedirectRoute,\n  getCustomRoute,\n  stringifyQuery\n} from 'next/dist/server/server-route-utils';\nimport { normalizePagePath } from 'next/dist/shared/lib/page-path/normalize-page-path';\nimport { Params } from 'next/dist/shared/lib/router/utils/route-matcher';\nimport { ParsedUrl } from 'next/dist/shared/lib/router/utils/parse-url';\nimport { getPathMatch } from 'next/dist/shared/lib/router/utils/path-match';\nimport { prepareDestination } from 'next/dist/shared/lib/router/utils/prepare-destination';\nimport { CacheFs, PageNotFoundError } from 'next/dist/shared/lib/utils';\n\nimport {\n  ComputeJsNextRequest,\n  ComputeJsNextResponse,\n} from './base-http/compute-js';\nimport { ComputeJsServerOptions } from './common';\nimport { getBackendInfo } from './compute-js';\nimport {\n  assetDirectory,\n  assetDirectoryExists,\n  assetFileExists,\n  getPagePath,\n  readAssetFileAsString,\n  readAssetManifest,\n  readAssetModule,\n  requireFontManifest,\n} from './require';\nimport { loadComponents } from './load-components';\nimport { serveStatic } from './serve-static';\nimport { getClonableBody } from \"next/dist/server/body-streams\";\nimport { isTargetLikeServerless } from \"next/dist/server/utils\";\nimport ResponseCache from \"next/dist/server/response-cache\";\nimport { IncrementalCache } from \"next/dist/server/lib/incremental-cache\";\nimport { normalizeAppPath } from \"next/dist/shared/lib/router/utils/app-paths\";\nimport { NextConfig } from \"next\";\nimport getRouteFromAssetPath from \"next/dist/shared/lib/router/utils/get-route-from-asset-path\";\nimport { normalizeLocalePath } from \"next/dist/shared/lib/i18n/normalize-locale-path\";\nimport { detectDomainLocale } from \"next/dist/shared/lib/i18n/detect-domain-locale\";\nimport { removeTrailingSlash } from \"next/dist/shared/lib/router/utils/remove-trailing-slash\";\nimport { isDynamicRoute } from \"next/dist/shared/lib/router/utils\";\n\n/**\n * Hardcoded every possible error status code that could be thrown by \"serveStatic\" method\n * This is done by searching \"this.error\" inside \"send\" module's source code:\n * https://github.com/pillarjs/send/blob/master/index.js\n * https://github.com/pillarjs/send/blob/develop/index.js\n */\nconst POSSIBLE_ERROR_CODE_FROM_SERVE_STATIC = new Set([\n  // send module will throw 500 when header is already sent or fs.stat error happens\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L392\n  // Note: we will use Next.js built-in 500 page to handle 500 errors\n  // 500,\n\n  // send module will throw 404 when file is missing\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L421\n  // Note: we will use Next.js built-in 404 page to handle 404 errors\n  // 404,\n\n  // send module will throw 403 when redirecting to a directory without enabling directory listing\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L484\n  // Note: Next.js throws a different error (without status code) for directory listing\n  // 403,\n\n  // send module will throw 400 when fails to normalize the path\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L520\n  400,\n\n  // send module will throw 412 with conditional GET request\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L632\n  412,\n\n  // send module will throw 416 when range is not satisfiable\n  // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L669\n  416,\n]);\n\n/**\n * An implementation of a Next.js server that has been adapted to run in Compute@Edge.\n * (An adaptation for Compute@Edge of NextNodeServer in Next.js,\n * found at next/server/next-server.ts)\n */\nexport default class NextComputeJsServer extends BaseServer<ComputeJsServerOptions> {\n  constructor(options: ComputeJsServerOptions) {\n    super(options);\n\n    /**\n     * This sets environment variable to be used at the time of SSR by head.tsx.\n     * Using this from process.env allows targeting both serverless and SSR by calling\n     * `process.env.__NEXT_OPTIMIZE_CSS`.\n     */\n    if (this.renderOpts.optimizeFonts) {\n      process.env.__NEXT_OPTIMIZE_FONTS = JSON.stringify(true);\n    }\n    if (this.renderOpts.optimizeCss) {\n      process.env.__NEXT_OPTIMIZE_CSS = JSON.stringify(true);\n    }\n    if (this.renderOpts.nextScriptWorkers) {\n      process.env.__NEXT_SCRIPT_WORKERS = JSON.stringify(true);\n    }\n\n    // pre-warm _document and _app as these will be\n    // needed for most requests\n    loadComponents(\n      this.serverOptions.computeJs.assets,\n      this.distDir,\n      '/_document',\n      this.dir,\n      this._isLikeServerless,\n      false,\n      false,\n    ).catch(\n      () => {}\n    );\n\n    loadComponents(\n      this.serverOptions.computeJs.assets,\n      this.distDir,\n      '/_app',\n      this.dir,\n      this._isLikeServerless,\n      false,\n      false,\n    ).catch(\n      () => {}\n    );\n  }\n\n  private compression = this.nextConfig.compress && this.nextConfig.target === 'server';\n\n  protected loadEnvConfig(params: { dev: boolean }): void {\n    // NOTE: No ENV in Fastly Compute@Edge, at least for now\n  }\n\n  protected getResponseCache({ dev }: { dev: boolean }) {\n    const incrementalCache = new IncrementalCache({\n      fs: this.getCacheFilesystem(),\n      dev,\n      serverDistDir: this.serverDistDir,\n      maxMemoryCacheSize: this.nextConfig.experimental.isrMemoryCacheSize,\n      flushToDisk:\n        !this.minimalMode && this.nextConfig.experimental.isrFlushToDisk,\n      incrementalCacheHandlerPath:\n      this.nextConfig.experimental?.incrementalCacheHandlerPath,\n      getPrerenderManifest: () => {\n        if (dev) {\n          return {\n            version: -1 as any, // letting us know this doesn't conform to spec\n            routes: {},\n            dynamicRoutes: {},\n            notFoundRoutes: [],\n            preview: null as any, // `preview` is special case read in next-dev-server\n          };\n        } else {\n          return this.getPrerenderManifest();\n        }\n      },\n    });\n\n    return new ResponseCache(incrementalCache, this.minimalMode);\n  }\n\n  protected getPublicDir(): string {\n    return join(this.dir, CLIENT_PUBLIC_FILES_PATH);\n  }\n\n  protected getHasStaticDir(): boolean {\n    return assetDirectoryExists(\n      this.serverOptions.computeJs.assets,\n      join(this.dir, 'static'),\n      this.dir,\n    );\n  }\n\n  protected getPagesManifest(): PagesManifest | undefined {\n    const pagesManifestFile = join(this.serverDistDir, PAGES_MANIFEST);\n    return readAssetManifest(\n      this.serverOptions.computeJs.assets,\n      pagesManifestFile,\n      this.dir\n    );\n  }\n\n  protected getAppPathsManifest(): PagesManifest | undefined {\n    if (this.nextConfig.experimental.appDir) {\n      const appPathsManifestPath = join(this.serverDistDir, APP_PATHS_MANIFEST);\n      return readAssetManifest(\n        this.serverOptions.computeJs.assets,\n        appPathsManifestPath,\n        this.dir\n      );\n    }\n    return undefined;\n  }\n\n  protected async hasPage(pathname: string): Promise<boolean> {\n    let found = false;\n    try {\n      found = !!this.getPagePath(pathname, this.nextConfig.i18n?.locales);\n    } catch (_) {}\n\n    return found;\n  }\n\n  protected getBuildId(): string {\n    const buildIdFile = join(this.distDir, BUILD_ID_FILE);\n\n    try {\n      const content = readAssetFileAsString(\n        this.serverOptions.computeJs.assets,\n        buildIdFile,\n        this.dir\n      );\n      return content.trim();\n    } catch (err) {\n      if (\n        !assetFileExists(\n          this.serverOptions.computeJs.assets,\n          buildIdFile,\n          this.dir,\n        )\n      ) {\n        throw new Error(\n          `Could not find a production build in the '${this.distDir}' directory. Try building your app with 'next build' before starting the production server. https://nextjs.org/docs/messages/production-start-no-build-id`\n        );\n      }\n      throw err;\n    }\n  }\n\n  protected getCustomRoutes(): CustomRoutes {\n    const customRoutes = this.getRoutesManifest();\n    let rewrites: CustomRoutes['rewrites'];\n\n    // rewrites can be stored as an array when an array is\n    // returned in next.config.js so massage them into\n    // the expected object format\n    if (Array.isArray(customRoutes.rewrites)) {\n      rewrites = {\n        beforeFiles: [],\n        afterFiles: customRoutes.rewrites,\n        fallback: [],\n      };\n    } else {\n      rewrites = customRoutes.rewrites;\n    }\n    return Object.assign(customRoutes, { rewrites });\n  }\n\n  protected generateImageRoutes(): Route[] {\n    // TODO: Image Optimizer\n    return [];\n  }\n\n  protected generateStaticRoutes(): Route[] {\n    return this.hasStaticDir\n      ? [\n          {\n            // It's very important to keep this route's param optional.\n            // (but it should support as many params as needed, separated by '/')\n            // Otherwise this will lead to a pretty simple DOS attack.\n            // See more: https://github.com/vercel/next.js/issues/2617\n            match: getPathMatch('/static/:path*'),\n            name: 'static catchall',\n            fn: async (req, res, params, parsedUrl) => {\n              const p = join(this.dir, 'static', ...params.path);\n              await this.serveStatic(req, res, p, parsedUrl);\n              return {\n                finished: true,\n              };\n            },\n          } as Route,\n        ]\n      : [];\n  }\n\n  protected setImmutableAssetCacheControl(res: BaseNextResponse): void {\n    res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n  }\n\n  protected generateFsStaticRoutes(): Route[] {\n    return [\n      {\n        match: getPathMatch('/_next/static/:path*'),\n        type: 'route',\n        name: '_next/static catchall',\n        fn: async (req, res, params, parsedUrl) => {\n          // make sure to 404 for /_next/static itself\n          if (!params.path) {\n            await this.render404(req, res, parsedUrl);\n            return {\n              finished: true,\n            };\n          }\n\n          if (\n            params.path[0] === CLIENT_STATIC_FILES_RUNTIME ||\n            params.path[0] === 'chunks' ||\n            params.path[0] === 'css' ||\n            params.path[0] === 'image' ||\n            params.path[0] === 'media' ||\n            params.path[0] === this.buildId ||\n            params.path[0] === 'pages' ||\n            params.path[1] === 'pages'\n          ) {\n            this.setImmutableAssetCacheControl(res);\n          }\n          const p = join(\n            this.distDir,\n            CLIENT_STATIC_FILES_PATH,\n            ...(params.path || [])\n          );\n          await this.serveStatic(req, res, p, parsedUrl);\n          return {\n            finished: true,\n          };\n        },\n      },\n    ];\n  }\n\n  protected generatePublicRoutes(): Route[] {\n    const publicFiles = new Set(\n      assetDirectory(\n        this.serverOptions.computeJs.assets,\n        this.publicDir,\n        this.dir,\n      ).map((p) => {\n        const realPath = resolve(this.dir, '.' + p);\n        const relPath = relative(this.publicDir, realPath);\n        return '/' + encodeURI(relPath.replace(/\\\\/g, '/'));\n      })\n    );\n    if(publicFiles.size === 0) {\n      return [];\n    }\n\n    return [\n      {\n        match: getPathMatch('/:path*'),\n        matchesBasePath: true,\n        name: 'public folder catchall',\n        fn: async (req, res, params, parsedUrl) => {\n          const pathParts: string[] = params.path || [];\n          const { basePath } = this.nextConfig;\n\n          // if basePath is defined require it be present\n          if (basePath) {\n            const basePathParts = basePath.split('/');\n            // remove first empty value\n            basePathParts.shift();\n\n            if (\n              !basePathParts.every((part: string, idx: number) =>\n                part === pathParts[idx]\n              )\n            ) {\n              return { finished: false };\n            }\n\n            pathParts.splice(0, basePathParts.length);\n          }\n\n          let path = `/${pathParts.join('/')}`;\n\n          if (!publicFiles.has(path)) {\n            // In `next-dev-server.ts`, we ensure encoded paths match\n            // decoded paths on the filesystem. So we need do the\n            // opposite here: make sure decoded paths match encoded.\n            path = encodeURI(path);\n          }\n\n          if (publicFiles.has(path)) {\n            await this.serveStatic(\n              req,\n              res,\n              join(this.publicDir, ...pathParts),\n              parsedUrl\n            );\n            return {\n              finished: true,\n            };\n          }\n          return {\n            finished: false,\n          };\n        },\n      } as Route,\n    ];\n  }\n\n  private _validFilesystemPathSet: Set<string> | null = null;\n  protected getFilesystemPaths(): Set<string> {\n    if (this._validFilesystemPathSet) {\n      return this._validFilesystemPathSet;\n    }\n\n    let userFilesStatic: string[] = [];\n    if (this.hasStaticDir) {\n      userFilesStatic = assetDirectory(\n        this.serverOptions.computeJs.assets,\n        join(this.dir, 'static'),\n        this.dir,\n      );\n    }\n\n    let userFilesPublic: string[] = [];\n    if (this.publicDir) {\n      userFilesPublic = assetDirectory(\n        this.serverOptions.computeJs.assets,\n        join(this.dir, CLIENT_PUBLIC_FILES_PATH),\n        this.dir,\n      );\n    }\n\n    let nextFilesStatic: string[] = [];\n    if(!this.minimalMode) {\n      userFilesStatic = assetDirectory(\n        this.serverOptions.computeJs.assets,\n        join(this.distDir, 'static'),\n        this.dir,\n      );\n    }\n\n    return (this._validFilesystemPathSet = new Set<string>([\n      ...nextFilesStatic,\n      ...userFilesPublic,\n      ...userFilesStatic,\n    ]));\n  }\n\n  protected async sendRenderResult(\n    req: ComputeJsNextRequest,\n    res: ComputeJsNextResponse,\n    options: {\n      result: RenderResult;\n      type: \"html\" | \"json\";\n      generateEtags: boolean;\n      poweredByHeader: boolean;\n      options?: PayloadOptions\n    }\n  ): Promise<void> {\n    return await sendRenderResult({\n      req: req.originalRequest,\n      res: res.originalResponse,\n      ...options,\n    });\n  }\n\n  protected async sendStatic(\n    req: ComputeJsNextRequest,\n    res: ComputeJsNextResponse,\n    path: string,\n  ): Promise<void> {\n    return serveStatic(\n      this.serverOptions.computeJs.assets,\n      req,\n      res,\n      path,\n      this.dir,\n    );\n  }\n\n  protected handleCompression(\n    req: ComputeJsNextRequest,\n    res: ComputeJsNextResponse\n  ): void {\n    if (this.compression) {\n      res.compress = true;\n    }\n  }\n\n  protected override async handleUpgrade(req: ComputeJsNextRequest, socket: any, head: any) {\n    // TODO: Upgrade websocket? (use Fanout?)\n  }\n\n  protected async proxyRequest(\n    req: ComputeJsNextRequest,\n    res: ComputeJsNextResponse,\n    parsedUrl: ParsedUrl,\n    upgradeHead?: any,\n  ) {\n    const { query } = parsedUrl;\n    delete (parsedUrl as any).query;\n    parsedUrl.search = stringifyQuery(req, query);\n\n    const target = formatUrl(parsedUrl);\n\n    const backend = getBackendInfo(this.serverOptions.computeJs.backends, target);\n    if(backend == null) {\n      // Unable to proxy, due to no backend\n      throw new Error(`Backend not found for '${target}'`);\n    }\n\n    const headers: Record<string, string> = {};\n\n    // Rewrite host header\n    headers['host'] = new URL(backend.url).host;\n\n    // XFF\n    const url = new URL(req.url);\n    const port = url.port || '443';       // C@E can only be on 443, except when running locally\n    const proto = 'https';                // C@E can only be accessed via HTTPS\n\n    const values: Record<string, string> = {\n      for: req.client.address,\n      port,\n      proto,\n    };\n\n    ['for', 'port', 'proto'].forEach(function(header) {\n      const arr: string[] = [];\n      let strs = req.headers['x-forwarded-' + header];\n      if(Array.isArray(strs)) {\n        strs = strs.join(',');\n      }\n      if(strs) {\n        arr.push(strs);\n      }\n      arr.push(values[header]);\n      headers['x-forwarded-' + header] = arr.join(',');\n    });\n\n    const body = await parseBody(req.originalRequest, 0);\n\n    // NOTE: Next.js uses a proxy timeout of 30s by default\n    // configurable using this.nextConfig.experimental.proxyTimeout\n    // In C@E we don't have a way of setting timeout\n\n    // NOTE: Next.js tries to use WS if upgradeHead is true.\n\n    const response = await fetch(backend.target, {\n      backend: backend.name,\n      method: req.method,\n      headers,\n      body: body,\n      cacheOverride: new CacheOverride('pass'),\n    });\n    const buffer = Buffer.from(await response.arrayBuffer());\n    res.statusCode = response.status;\n    response.headers.forEach((value, name) => {\n      res.setHeader(name, value);\n    });\n    res.originalResponse.end(buffer);\n\n    return {\n      finished: true,\n    };\n  }\n\n  protected async runApi(\n    req: BaseNextRequest | ComputeJsNextRequest,\n    res: BaseNextResponse | ComputeJsNextResponse,\n    query: ParsedUrlQuery,\n    params: Params | undefined,\n    page: string,\n    builtPagePath: string,\n  ): Promise<boolean> {\n    // node's next-server would try to run this first as an edge function.\n    // TODO: do that one day =)\n\n    const pageModule = await readAssetModule(\n      this.serverOptions.computeJs.assets,\n      builtPagePath,\n      this.dir\n    );\n\n    query = { ...query, ...params }\n\n    delete query.__nextLocale\n    delete query.__nextDefaultLocale\n\n    // NOTE: NextNodeServer would try to run this as a serverless\n    // it's hard to tell at this moment whether that is the right\n    // thing to do for us\n    // if (!this.renderOpts.dev && this._isLikeServerless) {\n    //   if (typeof pageModule.default === 'function') {\n    //     prepareServerlessUrl(req, query);\n    //     await pageModule.default(req, res);\n    //     return true;\n    //   }\n    // }\n\n    await apiResolver(\n      (req as ComputeJsNextRequest).originalRequest,\n      (res as ComputeJsNextResponse).originalResponse,\n      query,\n      pageModule,\n      {\n        ...this.renderOpts.previewProps,\n        // not implementing revalidate at this moment\n        // internal config so is not typed\n        trustHostHeader: (this.nextConfig.experimental as any).trustHostHeader,\n      },\n      this.minimalMode,\n      this.renderOpts.dev,\n      page\n    );\n    return true;\n  }\n\n  protected async renderHTML(\n    req: ComputeJsNextRequest,\n    res: ComputeJsNextResponse,\n    pathname: string,\n    query: NextParsedUrlQuery,\n    renderOpts: RenderOpts\n  ): Promise<RenderResult | null> {\n\n    // Due to the way we pass data by mutating `renderOpts`, we can't extend the\n    // object here but only updating its `serverComponentManifest` field.\n    // https://github.com/vercel/next.js/blob/df7cbd904c3bd85f399d1ce90680c0ecf92d2752/packages/next/server/render.tsx#L947-L952\n    renderOpts.serverComponentManifest = this.serverComponentManifest\n    renderOpts.serverCSSManifest = this.serverCSSManifest\n\n    /*\n    if (\n      this.nextConfig.experimental.appDir &&\n      (renderOpts.isAppPath || query.__flight__)\n    ) {\n      const isPagesDir = !renderOpts.isAppPath\n      return appRenderToHTMLOrFlight(\n        req.originalRequest,\n        res.originalResponse,\n        pathname,\n        query,\n        renderOpts,\n        isPagesDir\n      )\n    }\n     */\n\n    return renderToHTML(\n      req.originalRequest,\n      res.originalResponse,\n      pathname,\n      query,\n      renderOpts\n    );\n  }\n\n  public async serveStatic(\n    req: BaseNextRequest,\n    res: BaseNextResponse,\n    path: string,\n    parsedUrl?: UrlWithParsedQuery\n  ): Promise<void> {\n    if (!this.isServeableUrl(path)) {\n      return this.render404(req, res, parsedUrl);\n    }\n\n    if (!(req.method === 'GET' || req.method === 'HEAD')) {\n      res.statusCode = 405;\n      res.setHeader('Allow', ['GET', 'HEAD']);\n      return this.renderError(null, req, res, path);\n    }\n    \n    try {\n      await this.sendStatic(\n        req as ComputeJsNextRequest,\n        res as ComputeJsNextResponse,\n        path\n      );\n    } catch (error) {\n      if (!isError(error)) throw error;\n      const err = error as Error & { code?: string; statusCode?: number };\n      if (err.code === 'ENOENT' || err.statusCode === 404) {\n        await this.render404(req, res, parsedUrl);\n      } else if (\n        typeof err.statusCode === 'number' &&\n        POSSIBLE_ERROR_CODE_FROM_SERVE_STATIC.has(err.statusCode)\n      ) {\n        res.statusCode = err.statusCode;\n        return this.renderError(err, req, res, path);\n      } else {\n        throw err;\n      }\n    }\n  }\n\n  protected isServeableUrl(untrustedFileUrl: string): boolean {\n\n    // This method mimics what the version of `send` we use does:\n    // 1. decodeURIComponent:\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L989\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L518-L522\n    // 2. resolve:\n    //    https://github.com/pillarjs/send/blob/de073ed3237ade9ff71c61673a34474b30e5d45b/index.js#L561\n\n    let decodedUntrustedFilePath: string;\n    try {\n      // (1) Decode the URL so we have the proper file name\n      decodedUntrustedFilePath = decodeURIComponent(untrustedFileUrl);\n    } catch {\n      return false;\n    }\n\n    // (2) Resolve \"up paths\" to determine real request\n    const untrustedFilePath = resolve(decodedUntrustedFilePath);\n\n    // Check against the real filesystem paths\n    const filesystemUrls = this.getFilesystemPaths();\n    const resolved = relative(this.dir, untrustedFilePath);\n\n    return filesystemUrls.has('/' + resolved);\n  }\n\n  protected generateCatchAllMiddlewareRoute(): Route[] {\n    // TODO: Edge Functions / Middleware\n    // These are challenging at the moment to run in C@E, because\n    // Next.js builds middleware as edge functions, and edge functions\n    // are built as \"edge functions\" meant to run in Vercel's runtime.\n    return [];\n  }\n\n  protected generateRewrites({\n    restrictedRedirectPaths,\n  }: {\n    restrictedRedirectPaths: string[]\n  }) {\n    let beforeFiles: Route[] = [];\n    let afterFiles: Route[] = [];\n    let fallback: Route[] = [];\n\n    if (!this.minimalMode) {\n      const buildRewrite = (rewrite: Rewrite, check = true): Route => {\n        const rewriteRoute = getCustomRoute({\n          type: 'rewrite',\n          rule: rewrite,\n          restrictedRedirectPaths,\n        });\n        return {\n          ...rewriteRoute,\n          check,\n          type: rewriteRoute.type,\n          name: `Rewrite route ${rewriteRoute.source}`,\n          match: rewriteRoute.match,\n          matchesBasePath: true,\n          matchesLocale: true,\n          matchesLocaleAPIRoutes: true,\n          matchesTrailingSlash: true,\n          fn: async (req, res, params, parsedUrl, upgradeHead) => {\n            const { newUrl, parsedDestination } = prepareDestination({\n              appendParamsToQuery: true,\n              destination: rewriteRoute.destination,\n              params: params,\n              query: parsedUrl.query,\n            });\n\n            // external rewrite, proxy it\n            if (parsedDestination.protocol) {\n              // This implementation uses fetch() and can only go to preregistered backends.\n              // TODO: maybe we can use Dynamic Backends feature once it's available\n              return this.proxyRequest(\n                req as ComputeJsNextRequest,\n                res as ComputeJsNextResponse,\n                parsedDestination,\n                upgradeHead,\n              );\n            }\n\n            addRequestMeta(req, '_nextRewroteUrl', newUrl);\n            addRequestMeta(req, '_nextDidRewrite', newUrl !== req.url);\n\n            return {\n              finished: false,\n              pathname: newUrl,\n              query: parsedDestination.query,\n            };\n          },\n        }\n      }\n\n      if (Array.isArray(this.customRoutes.rewrites)) {\n        afterFiles = this.customRoutes.rewrites.map((r) => buildRewrite(r));\n      } else {\n        beforeFiles = this.customRoutes.rewrites.beforeFiles.map((r) =>\n          buildRewrite(r, false)\n        );\n        afterFiles = this.customRoutes.rewrites.afterFiles.map((r) =>\n          buildRewrite(r)\n        );\n        fallback = this.customRoutes.rewrites.fallback.map((r) =>\n          buildRewrite(r)\n        );\n      }\n    }\n\n    return {\n      beforeFiles,\n      afterFiles,\n      fallback,\n    };\n  }\n\n  protected getPagePath(\n    pathname: string,\n    locales?: string[],\n  ): string {\n    return getPagePath(\n      this.serverOptions.computeJs.assets,\n      pathname,\n      this.dir,\n      this.distDir,\n      this._isLikeServerless,\n      this.renderOpts.dev,\n      locales,\n      this.nextConfig.experimental.appDir\n    );\n  }\n\n  protected override async renderPageComponent(\n    ctx: RequestContext,\n    bubbleNoFallback: boolean\n  ) {\n    // node's next-server would try to run this first as an edge function.\n    // TODO: do that one day =)\n\n    return super.renderPageComponent(ctx, bubbleNoFallback)\n  }\n\n  protected async findPageComponents({\n    pathname,\n    query,\n    params,\n    isAppPath,\n  }: {\n    pathname: string\n    query: NextParsedUrlQuery\n    params: Params | null\n    isAppPath: boolean\n  }): Promise<FindComponentsResult | null>  {\n    let paths = [\n      // try serving a static AMP version first\n      query.amp ?\n        (isAppPath ?\n          normalizeAppPath(pathname) :\n          normalizePagePath(pathname)\n        ) + '.amp' : null,\n      pathname,\n    ].filter(Boolean);\n\n    if (query.__nextLocale) {\n      paths = [\n        ...paths.map(\n          (path) => `/${query.__nextLocale}${path === '/' ? '' : path}`\n        ),\n        ...paths,\n      ];\n    }\n\n    for (const pagePath of paths) {\n      try {\n        const components = await loadComponents(\n          this.serverOptions.computeJs.assets,\n          this.distDir,\n          pagePath!,\n          this.dir,\n          !this.renderOpts.dev && this._isLikeServerless,\n          !!this.renderOpts.serverComponents,\n          isAppPath,\n        );\n\n        if (\n          query.__nextLocale &&\n          typeof components.Component === 'string' &&\n          !pagePath?.startsWith(`/${query.__nextLocale}`)\n        ) {\n          // if loading a static HTML file the locale is required\n          // to be present since all HTML files are output under their locale\n          continue;\n        }\n\n        return {\n          components,\n          query: {\n            ...(components.getStaticProps\n              ? ({\n                  amp: query.amp,\n                  __nextDataReq: query.__nextDataReq,\n                  __nextLocale: query.__nextLocale,\n                  __nextDefaultLocale: query.__nextDefaultLocale,\n                  __flight__: query.__flight__,\n                } as NextParsedUrlQuery)\n              : query),\n            // For appDir params is excluded.\n            ...((isAppPath ? {} : params) || {}),\n          },\n        };\n      } catch (err) {\n        // we should only not throw if we failed to find the page\n        // in the pages-manifest\n        if (!(err instanceof PageNotFoundError)) {\n          throw err;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  protected getFontManifest(): FontManifest | undefined {\n    return requireFontManifest(\n      this.serverOptions.computeJs.assets,\n      this.distDir,\n      this.dir,\n      this._isLikeServerless,\n    );\n  }\n\n  protected getServerComponentManifest(): any {\n    // TODO: If we want to support Server Components\n    return undefined;\n  }\n\n  protected getServerCSSManifest() {\n    // TODO: If we want to support Server Components\n    return undefined;\n  }\n\n  protected override async getFallback(page: string) {\n    const pagePath = normalizePagePath(page);\n    const fullPagePath = join(this.serverDistDir, 'pages', `${pagePath}.html`);\n    return readAssetFileAsString(\n      this.serverOptions.computeJs.assets,\n      fullPagePath,\n      this.dir\n    );\n  }\n\n  protected generateRoutes(): {\n    headers: Route[]\n    rewrites: {\n      beforeFiles: Route[]\n      afterFiles: Route[]\n      fallback: Route[]\n    }\n    fsRoutes: Route[]\n    redirects: Route[]\n    catchAllRoute: Route\n    catchAllMiddleware: Route[]\n    pageChecker: PageChecker\n    useFileSystemPublicRoutes: boolean\n    dynamicRoutes: DynamicRoutes | undefined\n    nextConfig: NextConfig\n  } {\n    const publicRoutes = this.generatePublicRoutes();\n    const imageRoutes = this.generateImageRoutes();\n    const staticFilesRoutes = this.generateStaticRoutes();\n\n    const fsRoutes: Route[] = [\n      ...this.generateFsStaticRoutes(),\n      {\n        match: getPathMatch('/_next/data/:path*'),\n        type: 'route',\n        name: '_next/data catchall',\n        check: true,\n        fn: async (req, res, params, _parsedUrl) => {\n          // Make sure to 404 for /_next/data/ itself and\n          // we also want to 404 if the buildId isn't correct\n          if (!params.path || params.path[0] !== this.buildId) {\n            await this.render404(req, res, _parsedUrl)\n            return {\n              finished: true,\n            };\n          }\n          // remove buildId from URL\n          params.path.shift();\n\n          const lastParam = params.path[params.path.length - 1];\n\n          // show 404 if it doesn't end with .json\n          if (typeof lastParam !== 'string' || !lastParam.endsWith('.json')) {\n            await this.render404(req, res, _parsedUrl);\n            return {\n              finished: true,\n            };\n          }\n\n          // re-create page's pathname\n          let pathname = `/${params.path.join('/')}`;\n          pathname = getRouteFromAssetPath(pathname, '.json');\n\n          // ensure trailing slash is normalized per config\n          if (this.router.catchAllMiddleware[0]) {\n            if (this.nextConfig.trailingSlash && !pathname.endsWith('/')) {\n              pathname += '/';\n            }\n            if (\n              !this.nextConfig.trailingSlash &&\n              pathname.length > 1 &&\n              pathname.endsWith('/')\n            ) {\n              pathname = pathname.substring(0, pathname.length - 1);\n            }\n          }\n\n          if (this.nextConfig.i18n) {\n            const { host } = req?.headers || {};\n            // remove port from host and remove port if present\n            const hostname = host?.split(':')[0].toLowerCase();\n            const localePathResult = normalizeLocalePath(\n              pathname,\n              this.nextConfig.i18n.locales\n            );\n            const { defaultLocale } =\n              detectDomainLocale(this.nextConfig.i18n.domains, hostname) || {};\n\n            let detectedLocale = '';\n\n            if (localePathResult.detectedLocale) {\n              pathname = localePathResult.pathname;\n              detectedLocale = localePathResult.detectedLocale;\n            }\n\n            _parsedUrl.query.__nextLocale = detectedLocale;\n            _parsedUrl.query.__nextDefaultLocale =\n              defaultLocale || this.nextConfig.i18n.defaultLocale;\n\n            if (!detectedLocale && !this.router.catchAllMiddleware[0]) {\n              _parsedUrl.query.__nextLocale =\n                _parsedUrl.query.__nextDefaultLocale;\n              await this.render404(req, res, _parsedUrl);\n              return { finished: true };\n            }\n          }\n\n          return {\n            pathname,\n            query: { ..._parsedUrl.query, __nextDataReq: '1' },\n            finished: false,\n          };\n        },\n      },\n      ...imageRoutes,\n      {\n        match: getPathMatch('/_next/:path*'),\n        type: 'route',\n        name: '_next catchall',\n        // This path is needed because `render()` does a check for `/_next` and the calls the routing again\n        fn: async (req, res, _params, parsedUrl) => {\n          await this.render404(req, res, parsedUrl);\n          return {\n            finished: true,\n          };\n        },\n      },\n      ...publicRoutes,\n      ...staticFilesRoutes,\n    ];\n\n    const restrictedRedirectPaths = this.nextConfig.basePath\n      ? [`${this.nextConfig.basePath}/_next`]\n      : ['/_next'];\n\n    // Headers come very first\n    const headers = this.minimalMode ?\n      [] :\n      this.customRoutes.headers.map((rule) =>\n        createHeaderRoute({ rule, restrictedRedirectPaths })\n      );\n\n    const redirects = this.minimalMode ?\n      [] :\n      this.customRoutes.redirects.map((rule) =>\n        createRedirectRoute({ rule, restrictedRedirectPaths })\n      );\n\n    const rewrites = this.generateRewrites({ restrictedRedirectPaths });\n    const catchAllMiddleware = this.generateCatchAllMiddlewareRoute();\n\n    const catchAllRoute: Route = {\n      match: getPathMatch('/:path*'),\n      type: 'route',\n      matchesLocale: true,\n      name: 'Catchall render',\n      fn: async (req, res, _params, parsedUrl) => {\n        let { pathname, query } = parsedUrl;\n        if (!pathname) {\n          throw new Error('pathname is undefined');\n        }\n\n        // next.js core assumes page path without trailing slash\n        pathname = removeTrailingSlash(pathname);\n\n        if (this.nextConfig.i18n) {\n          const localePathResult = normalizeLocalePath(\n            pathname,\n            this.nextConfig.i18n?.locales\n          );\n\n          if (localePathResult.detectedLocale) {\n            pathname = localePathResult.pathname;\n            parsedUrl.query.__nextLocale = localePathResult.detectedLocale;\n          }\n        }\n        const bubbleNoFallback = !!query._nextBubbleNoFallback;\n\n        if (pathname === '/api' || pathname.startsWith('/api/')) {\n          delete query._nextBubbleNoFallback;\n\n          const handled = await this.handleApiRequest(req, res, pathname, query);\n          if (handled) {\n            return { finished: true };\n          }\n        }\n\n        try {\n          await this.render(req, res, pathname, query, parsedUrl, true);\n\n          return {\n            finished: true,\n          };\n        } catch (err) {\n          if (err instanceof NoFallbackError && bubbleNoFallback) {\n            return {\n              finished: false,\n            };\n          }\n          throw err;\n        }\n      },\n    }\n\n    const { useFileSystemPublicRoutes } = this.nextConfig;\n\n    if (useFileSystemPublicRoutes) {\n      this.appPathRoutes = this.getAppPathRoutes();\n      this.dynamicRoutes = this.getDynamicRoutes();\n    }\n\n    return {\n      headers,\n      fsRoutes,\n      rewrites,\n      redirects,\n      catchAllRoute,\n      catchAllMiddleware,\n      useFileSystemPublicRoutes,\n      dynamicRoutes: this.dynamicRoutes,\n      pageChecker: this.hasPage.bind(this),\n      nextConfig: this.nextConfig,\n    };\n  }\n\n  // Used to build API page in development\n  protected async ensureApiPage(_pathname: string): Promise<void> {}\n\n  /**\n   * Resolves `API` request, in development builds on demand\n   * @param req http request\n   * @param res http response\n   * @param pathname path of request\n   */\n  protected async handleApiRequest(\n    req: BaseNextRequest,\n    res: BaseNextResponse,\n    pathname: string,\n    query: ParsedUrlQuery\n  ): Promise<boolean> {\n    let page = pathname;\n    let params: Params | undefined = undefined;\n    let pageFound = !isDynamicRoute(page) && (await this.hasPage(page));\n\n    if (!pageFound && this.dynamicRoutes) {\n      for (const dynamicRoute of this.dynamicRoutes) {\n        params = dynamicRoute.match(pathname) || undefined;\n        if (dynamicRoute.page.startsWith('/api') && params) {\n          page = dynamicRoute.page;\n          pageFound = true;\n          break;\n        }\n      }\n    }\n\n    if (!pageFound) {\n      return false;\n    }\n    // Make sure the page is built before getting the path\n    // or else it won't be in the manifest yet\n    await this.ensureApiPage(page);\n\n    let builtPagePath\n    try {\n      builtPagePath = this.getPagePath(page);\n    } catch (err) {\n      if (isError(err) && err.code === 'ENOENT') {\n        return false;\n      }\n      throw err\n    }\n\n    return this.runApi(req, res, query, params, page, builtPagePath);\n  }\n\n  // We're going to use the time the build happened as the last modified time for the\n  // sake of the cache file system for now.\n  private static _mtime = new Date();\n  protected getCacheFilesystem(): CacheFs {\n    return {\n      readFile: (f) => {\n        const content = readAssetFileAsString(\n          this.serverOptions.computeJs.assets,\n          f,\n          this.dir\n        );\n        return Promise.resolve(content);\n      },\n      readFileSync: (f) => {\n        return readAssetFileAsString(\n          this.serverOptions.computeJs.assets,\n          f,\n          this.dir\n        );\n      },\n      writeFile: (f, d) => {\n        throw new Error(\"Writing to cache not currently supported\");\n      },\n      mkdir: (dir) => {\n        // writing to cache not currently supported, but silently succeed on mkdir for now\n        return Promise.resolve();\n      },\n      stat: (f) => {\n        return Promise.resolve({mtime: NextComputeJsServer._mtime});\n      },\n    }\n  }\n\n  private _cachedPreviewManifest: PrerenderManifest | undefined\n  protected getPrerenderManifest(): PrerenderManifest {\n    if (this._cachedPreviewManifest) {\n      return this._cachedPreviewManifest\n    }\n    const manifestFile = join(this.distDir, PRERENDER_MANIFEST);\n    const manifest = readAssetManifest(\n      this.serverOptions.computeJs.assets,\n      manifestFile,\n      this.dir\n    );\n    return (this._cachedPreviewManifest = manifest);\n  }\n\n  protected getRoutesManifest(): CustomRoutes {\n    const routesManifestFile = join(this.distDir, ROUTES_MANIFEST);\n    return readAssetManifest(\n      this.serverOptions.computeJs.assets,\n      routesManifestFile,\n      this.dir\n    );\n  }\n\n  protected attachRequestMeta(\n    req: BaseNextRequest,\n    parsedUrl: NextUrlWithParsedQuery\n  ) {\n    // In C@E, the protocol is always https on prod and http on dev\n    const hostname = 'localhost';\n    const protocol = hostname !== 'localhost' ? 'https' : 'http';\n\n    // When there are hostname and port we build an absolute URL\n    const initUrl =\n      this.hostname && this.port\n        ? `${protocol}://${this.hostname}:${this.port}${req.url}`\n        : req.url;\n\n    addRequestMeta(req, '__NEXT_INIT_URL', initUrl);\n    addRequestMeta(req, '__NEXT_INIT_QUERY', { ...parsedUrl.query });\n    addRequestMeta(req, '_protocol', protocol);\n    addRequestMeta(req, '__NEXT_CLONABLE_BODY', getClonableBody(req.body));\n  }\n\n  protected get _isLikeServerless(): boolean {\n    return isTargetLikeServerless(this.nextConfig.target);\n  }\n\n  protected get serverDistDir() {\n    return join(\n      this.distDir,\n      this._isLikeServerless ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n    );\n  }\n}\n"]}